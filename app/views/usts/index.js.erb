var site = $("#progression");
site.hide();
site.html("<%= j render('progression', progression:@progression)%>");
site.fadeIn();

MIDI.loadPlugin({
  soundfontUrl: "/assets/",
  instrument: "acoustic_grand_piano",
  onprogress: function(state, progress) {
    console.log(state, progress);
  },
  onsuccess: function() {
    stopAudio();
    MIDI.setVolume(0, 100);

    var progression = [ <%= raw @progression.map{|chord| "'#{chord.root.sub('â™­','b')}2'"}.join(",") %> ];
    var index = 0;
    function play(){
      MIDI.noteOn(0, MIDI.keyToNote[progression[index]], 120, 0);
      MIDI.noteOff(0, MIDI.keyToNote[progression[index]], 0.70);
      var tds = $("table.progression td").removeClass('current');
      if (index >= progression.length) {return stopAudio();}

      var td = $(tds[index]).addClass('current');
      index++;
    }
    window.intervalId = setInterval(play, 3500);
  }
});
